---
# Deploy n8n workflow automation

- name: Create n8n data directory
  file:
    path: "{{ n8n_data_dir }}"
    state: directory
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0755'

- name: Pull n8n Docker image
  community.docker.docker_image:
    name: "n8nio/n8n:{{ n8n_version }}"
    source: pull

- name: Deploy n8n container
  community.docker.docker_container:
    name: "{{ n8n_container_name }}"
    image: "n8nio/n8n:{{ n8n_version }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ n8n_port }}:5678"
    volumes:
      - "{{ n8n_data_dir }}:/home/node/.n8n"
    etc_hosts:
      host.docker.internal: host-gateway
    env:
      GENERIC_TIMEZONE: "{{ n8n_timezone }}"
      TZ: "{{ n8n_timezone }}"
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: "{{ ai_hub_user }}"
      N8N_BASIC_AUTH_PASSWORD: "{{ lookup('password', '/tmp/n8n_password chars=ascii_letters,digits length=16') }}"
      WEBHOOK_URL: "http://{{ ansible_host }}:{{ n8n_port }}/"
      ANTHROPIC_API_KEY: "{{ anthropic_api_key }}"
      OPENAI_API_KEY: "{{ openai_api_key }}"

- name: Wait for n8n to be ready
  uri:
    url: "http://localhost:{{ n8n_port }}"
    status_code: [200, 401]
  register: result
  until: result.status in [200, 401]
  retries: 30
  delay: 2

- name: Create n8n credentials directory
  file:
    path: "{{ ai_hub_base_path }}/config/n8n-credentials"
    state: directory
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0700'

- name: Deploy Telegram credential file
  template:
    src: telegram-credential.json.j2
    dest: "{{ ai_hub_base_path }}/config/n8n-credentials/telegram-credential.json"
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0600'
  when: telegram_bot_token | length > 0

- name: Import Telegram credential into n8n
  command: >
    docker exec {{ n8n_container_name }} n8n import:credentials
    --input=/home/node/.n8n/../../../opt/ai-hub/config/n8n-credentials/telegram-credential.json
  args:
    chdir: "{{ ai_hub_base_path }}"
  when: telegram_bot_token | length > 0
  ignore_errors: yes
  register: telegram_cred_import

- name: Copy credential file into container and import
  block:
    - name: Copy credential to container
      command: docker cp {{ ai_hub_base_path }}/config/n8n-credentials/telegram-credential.json {{ n8n_container_name }}:/tmp/telegram-credential.json

    - name: Import credential from container tmp
      command: docker exec {{ n8n_container_name }} n8n import:credentials --input=/tmp/telegram-credential.json

    - name: Cleanup credential file in container
      command: docker exec {{ n8n_container_name }} rm /tmp/telegram-credential.json
  when: telegram_bot_token | length > 0 and telegram_cred_import.rc != 0

# SSH Credential for Claude CLI access
- name: Deploy SSH credential file
  template:
    src: ssh-credential.json.j2
    dest: "{{ ai_hub_base_path }}/config/n8n-credentials/ssh-credential.json"
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0600'
  when: ai_hub_ssh_password | length > 0

- name: Import SSH credential into n8n
  block:
    - name: Copy SSH credential to container
      command: docker cp {{ ai_hub_base_path }}/config/n8n-credentials/ssh-credential.json {{ n8n_container_name }}:/tmp/ssh-credential.json

    - name: Import SSH credential
      command: docker exec {{ n8n_container_name }} n8n import:credentials --input=/tmp/ssh-credential.json

    - name: Cleanup SSH credential file in container
      command: docker exec {{ n8n_container_name }} rm /tmp/ssh-credential.json
  when: ai_hub_ssh_password | length > 0

# Telegram Claude Bot Workflow
- name: Create n8n workflows directory
  file:
    path: "{{ ai_hub_base_path }}/config/n8n-workflows"
    state: directory
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0755'

- name: Deploy Telegram Claude workflow file
  template:
    src: telegram-claude-workflow.json.j2
    dest: "{{ ai_hub_base_path }}/config/n8n-workflows/telegram-claude-workflow.json"
    owner: "{{ ai_hub_user }}"
    group: "{{ ai_hub_user }}"
    mode: '0644'
  when: telegram_workflow_enabled | default(true) and telegram_bot_token | length > 0 and ai_hub_ssh_password | length > 0

- name: Import Telegram Claude workflow into n8n
  block:
    - name: Copy workflow to container
      command: docker cp {{ ai_hub_base_path }}/config/n8n-workflows/telegram-claude-workflow.json {{ n8n_container_name }}:/tmp/telegram-claude-workflow.json

    - name: Import workflow
      command: docker exec {{ n8n_container_name }} n8n import:workflow --input=/tmp/telegram-claude-workflow.json

    - name: Cleanup workflow file in container
      command: docker exec {{ n8n_container_name }} rm /tmp/telegram-claude-workflow.json
  when: telegram_workflow_enabled | default(true) and telegram_bot_token | length > 0 and ai_hub_ssh_password | length > 0

- name: Display n8n status
  debug:
    msg: |
      n8n deployed successfully:
        - Web UI: http://{{ ansible_host }}:{{ n8n_port }}
        - Username: {{ ai_hub_user }}
        - Password: {{ lookup('password', '/tmp/n8n_password chars=ascii_letters,digits length=16') }}
        - Data directory: {{ n8n_data_dir }}
        - Telegram credential: {{ 'Imported' if telegram_bot_token | length > 0 else 'Not configured (set TELEGRAM_BOT_TOKEN env var)' }}
        - SSH credential: {{ 'Imported' if ai_hub_ssh_password | length > 0 else 'Not configured (set AI_HUB_SSH_PASSWORD env var)' }}
        - Telegram Claude workflow: {{ 'Imported and active' if telegram_workflow_enabled | default(true) and telegram_bot_token | length > 0 and ai_hub_ssh_password | length > 0 else 'Not deployed' }}
