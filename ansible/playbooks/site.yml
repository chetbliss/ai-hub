---
- name: Configure AI Hub v2 - Complete Setup
  hosts: ai_hub
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Display deployment info
      debug:
        msg: |
          Deploying AI Hub v2 to: {{ vm_name }} ({{ ansible_host }})
          Environment: {{ environment }}

  roles:
    - base-system          # Docker, Node.js, common tools
    - claude-cli           # Claude CLI installation
    - gemini-cli           # Gemini CLI installation
    - qdrant               # Vector database
    - sqlite               # SQLite setup for structured data
    - n8n                  # n8n workflow automation
    - open-webui           # Open WebUI chat interface
    - open-webui-pipelines # Pipelines for Claude/Anthropic support
    - mcp-proxmox          # Proxmox MCP server (gilby125/mcp-proxmox - 55 tools)
    - mcp-unifi            # UniFi MCP server (sirkirby/unifi-network-mcp)
    - mcp-memory           # Custom memory MCP server
    - mcpo                 # MCP-to-OpenAPI proxy for Open WebUI access to MCP tools
    - document-ingestion   # Initial markdown ingestion

  post_tasks:
    - name: Display AI Hub status
      debug:
        msg: |
          ========================================
          AI Hub {{ vm_name }} configured successfully!
          ========================================
          Services running:
            - Claude CLI: Installed
            - Gemini CLI: Installed
            - Open WebUI: http://{{ ansible_host }}:3000 (Web chat with Claude + 34 MCP tools)
            - Open WebUI Pipelines: http://{{ ansible_host }}:9099 (Claude/Anthropic support)
            - mcpo (MCP Proxy): http://{{ ansible_host }}:8000 (Exposes MCP tools to web)
            - n8n: http://{{ ansible_host }}:5678
            - Qdrant: http://{{ ansible_host }}:6333

          MCP Tools (34 tools - accessible via web, NO SSH NEEDED):
            - Memory/Knowledge: 16 tools (quiz, snippets, issues, search)
            - News Aggregator: 9 tools (RSS feeds, trending, summaries)
            - Proxmox: 55 tools (VM management, storage, networking)
            - UniFi: Tools for network management

          Next steps:
            1. Access Open WebUI: http://{{ ansible_host }}:3000
            2. Create admin account
            3. Use Claude with MCP tools via web browser - NO SSH REQUIRED
          ========================================
